#!/bin/bash

# Repodoc Tool written by Jos√© Luis Rivero (yoswink@gentoo.org)
# Version 0.1_alpha
# Distributed under the terms of the GNU General Public License v2

MODULE_NAME="Checks links sanity"
KEYWORDS="*"

LEVEL="BASIC"

exec_module() {
	local external anchor_rex anchor \
		found anchor_found linked LINKS \
		out offending_links retVal=0

	# We have three types of links
	# 1. gentoo own links : /doc or /proj   ( internal - check          )
	# 2. anchors : #links                   ( internal - check          )
	# 3. outside links : www and http...    ( external - cannot check   )
	# 4. Odd uris : irc mailto nx ssh ...   ( external - will not check )

	LINKS=$(sed -n -e '
		/<uri[[:blank:]]*$/ {
			n
			s-link="\([^"]*\)".*$-\1-
			H
		}
		/.*<uri>\([^<]*\)<\/uri>.*/ {
			s--\1-g
			H
		}
		/.*<uri[[:blank:]]*link="\(.*\)">[^<]*<\/uri>.*/ {
			s--\1-g
			H
		}
		$ {
			x
			s-\n- -gp
		}' ${DOC})

	for link in ${LINKS} ; do
		anchor=${link##*#}
		anchor_rex='<[^ ]*[[:blank:]]*id="'${anchor}'"'
		anchor_found=true
		found=false

		case ${link} in
			http?://*|ftp?://*|www.*)
				# Cannot check this links right now
				external=true
			;;
			'#*')
				# Anchor, internal, check it
				external=false
				grep "${anchor_rex}" ${DOC} > /dev/null && found=true || found=false
			;;
			/doc/*|/proj/*)
				# Gentoo link, internal, check it
				external=false
				found=false
				linked=${CVS_ROOT}/${link%%#*}

				# Does the file/directory exist ?
				[[ -e ${linked%%\?*} ]] && found=true

				# If we were given an anchor, check it unless it is a doc_ anchor
				case ${found},${anchor} in
					true,doc_*)   ;; # Skip doc_ anchors
					true,${link}) ;; # Skip if no anchor given
					true,*)
						grep "${anchor_rex}" ${linked%%\?*} > /dev/null \
							&& anchor_found=true || anchor_found=false
					;;
				esac

				${found} && ${anchor_found} || { [[ ${retVal} < 2 ]] && retVal=1 ;}
			;;
			*)
				# What on earth are you linking to?
				external=true
			;;
		esac

		${found} || ${external} || retVal=2

		case ${external},${found},${anchor_found} in
			true,*,*) ;;   # Skip external links
			false,false,*) out="${out},,,Link not found - ${link}" ;;
			false,true,false) out="${out},,,Anchor '${anchor}' not found in '${linked}'" ;;
		esac
	done

	# A bit hacky, but works fine
	offending_links=$(sed -e 's-,,,-\n-g' <<< ${out})
	OUTPUT_TEXT="${offending_links}"

	return ${retVal}
}
